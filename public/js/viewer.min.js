function updateData(){$("#title-value").text(data.title),$("#description-value").text(data.description);var t=data.ballotBoxes,a=$("#ballot-boxes"),e=null===a.val()?-1:a.val();a.empty(),a.append($("<option>",{id:"bb-option-total",value:-1,text:"Total",selected:!0}));for(var o=0;o<t.length;o++)a.append($("<option>",{id:"bb-option-"+o,value:o,text:t[o].name}));e=Math.min(e,t.length-1),a.val(e),setBallotBoxesVal(e);var l=data.options;$("#options").empty();for(var o=0;o<l.length;o++){name=l[o].name,color=l[o].color;var n=0,s=0;if(-1!=e)n=t[e].options[o],s=getBBVotes(e);else for(var i=0;i<data.ballotBoxes.length;i++)n+=data.ballotBoxes[i].options[o],s+=getBBVotes(i);percentage=100*n/s,genBBOption(name,color,n,percentage.toFixed(2),o)}updateChart()}function setBallotBoxesVal(t){for(var a=0,e=0,o=0;o<data.ballotBoxes.length;o++)a+=parseInt(getBBVotes(o)),e+=parseInt(data.ballotBoxes[o].quorum);if(-1==t){var l=e,n=a;$("#bb-name-value").text("Total"),$("#bb-votes-value").text(n)}else{var s=data.ballotBoxes[t],l=s.quorum,n=getBBVotes(t);console.log("antes:"+n),$("#bb-name-value").text(s.name),$("#bb-votes-value").text(n)}var i=100*n/l;$("#bb-quorum-value").text(""+i.toFixed(2)+"% ("+l+")")}function getBBVotes(t){var a=data.ballotBoxes[t];if(a.votes>0)return a.votes;for(var e=0,o=0;o<a.options.length;o++)e+=a.options[o];return e}function setOptionsVal(t){for(var a="option-",e=0;e<data.options.length;e++){if(-1==t)for(var o=0,l=0,n=0;n<data.ballotBoxes.length;n++)o+=parseInt(data.ballotBoxes[n].options[e]),l+=parseInt(getBBVotes(n));else var o=data.ballotBoxes[t].options[e],l=getBBVotes(t);var s=100*o/l;$("#"+a+e+"-value").text(o),$("#"+a+e+"-percentage-value").text(s.toFixed(2))}}function genBBOption(t,a,e,o,l){var n=$("#options"),s="option-"+l;n.append($("<tr>",{id:s}).append($("<td>",{type:"text","class":"form-control input-sm",id:s+"-name-value",text:t})).append($("<td>",{type:"text","class":"form-control input-sm",id:s+"-name-value",style:"background-color:"+a})).append($("<td>",{type:"text","class":"form-control input-sm",id:s+"-value",text:e})).append($("<td>",{type:"text","class":"form-control input-sm",id:s+"-percentage-value",text:o})))}function bindSelect(){$("#ballot-boxes").change(selectBallotBoxesAction)}function selectBallotBoxesAction(){var t=$("#ballot-boxes").val();setBallotBoxesVal(t),setOptionsVal(t),updateChart()}function generateChartData(){var t=[],a=$("#ballot-boxes").val();if(-1==a){for(var e={name:"Total",votes:0,quorum:0,options:[]},o=0;o<data.options.length;o++)e.options[o]=0;for(var l=0;l<data.ballotBoxes.length;l++){e.votes+=getBBVotes(l),e.quorum+=data.ballotBoxes[l].quorum;for(var o=0;o<data.options.length;o++)e.options[o]+=data.ballotBoxes[l].options[o]}}else var e=data.ballotBoxes[a];for(var o=0;o<data.options.length;o++)t[o]={value:e.options[o],color:data.options[o].color,highlight:"#BEBEBE",label:data.options[o].name};return t}function updateChart(){null!==myPieChart&&myPieChart.destroy(),chartData=generateChartData(),ctx=$("#myChart").get(0).getContext("2d"),myPieChart=new Chart(ctx).Pie(chartData,{animation:!1,segmentShowStroke:!1})}var data,chartData,ctx,myPieChart=null;socket.on("data",function(t){console.log("Updating new data..."),data=t,updateData()}),socket.on("dataBit",function(t){console.log(t);var a,e=data;for(a=0;a<t.field.length-1;a++)e=e[t.field[a]];if("DELETE"!=t.value){if(console.log("Updating a bit of data..."),e[t.field[a]]=t.value,"options"==t.field[0]&&2==t.field.length)for(var a=0;a<data.ballotBoxes.length;a++){var o=data.ballotBoxes[a].options;o[o.length]=0}}else{var l=t.field[a];if(e.splice(l,1),console.log("data Deleted!"),"options"==t.field[0]&&2==t.field.length)for(var a=0;a<data.ballotBoxes.length;a++)data.ballotBoxes[a].options.splice(l,1);if("ballotBoxes"==t.field[0]){bbID=t.field[1];var n=$("#ballot-boxes"),s=null===n.val()?-1:n.val();s>=0&&bbID<=s&&n.val(s-1)}}updateData()}),$(document).ready(function(){bindSelect()});